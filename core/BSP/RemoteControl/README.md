# RemoteControl - é¥æ§å™¨é©±åŠ¨

> ğŸ“š **å‰ç½®çŸ¥è¯†**ï¼šUART ä¸²å£é€šä¿¡åŸºç¡€
>
> é¥æ§å™¨æ˜¯æ“æ§æœºå™¨äººçš„ä¸»è¦è¾“å…¥è®¾å¤‡ï¼Œè¿™ä¸ªæ¨¡å—å¸®ä½ è§£æ DT7 é¥æ§å™¨æ•°æ®ã€‚

---

## ğŸ¯ è¿™ä¸ªæ¨¡å—æ˜¯å¹²ä»€ä¹ˆçš„ï¼Ÿ

DT7 é¥æ§å™¨é€šè¿‡æ¥æ”¶æœºè¿æ¥åˆ° STM32ï¼Œæ•°æ®é€šè¿‡ **UART** ä¸²å£ä¼ è¾“ã€‚è¿™ä¸ªæ¨¡å—è´Ÿè´£ï¼š

1. **è§£æåŸå§‹æ•°æ®**ï¼šæŠŠä¸²å£æ”¶åˆ°çš„ 18 å­—èŠ‚æ•°æ®è§£ææˆæœ‰æ„ä¹‰çš„å€¼
2. **æä¾›ä¾¿æ·æ¥å£**ï¼šç›´æ¥è·å–æ‘‡æ†ã€å¼€å…³ã€é”®ç›˜ç­‰çŠ¶æ€
3. **æ‰çº¿æ£€æµ‹**ï¼šé¥æ§å™¨å¤±è”æ—¶è‡ªåŠ¨æŠ¥è­¦

---

## ğŸ® DT7 é¥æ§å™¨ç»“æ„

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚              DT7 é¥æ§å™¨              â”‚
                    â”‚                                     â”‚
    å·¦å¼€å…³ S1 â”€â”€â”€â”€â”€â†’ â”‚  [ä¸Š]                        [ä¸Š]  â”‚ â†â”€â”€â”€â”€â”€ å³å¼€å…³ S2
    (3æ¡£)           â”‚  [ä¸­]                        [ä¸­]  â”‚         (3æ¡£)
                    â”‚  [ä¸‹]                        [ä¸‹]  â”‚
                    â”‚                                     â”‚
                    â”‚      â— â†â”€â”€ å·¦æ‘‡æ†          å³æ‘‡æ† â”€â”€â†’ â—      â”‚
                    â”‚     (X,Y)                    (X,Y) â”‚
                    â”‚                                     â”‚
                    â”‚                [æ»šè½®]               â”‚
                    â”‚                                     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    è¿˜æœ‰ï¼šé”®ç›˜æŒ‰é”®ã€é¼ æ ‡ï¼ˆå›¾ä¼ ä½¿ç”¨ï¼‰
```

### æ•°æ®å¯¹åº”å…³ç³»

| ç‰©ç†éƒ¨ä»¶    | æ•°æ®åç§° | èŒƒå›´                   |
| ----------- | -------- | ---------------------- |
| å³æ‘‡æ† X è½´ | ch0      | 364 - 1684 (ä¸­å€¼ 1024) |
| å³æ‘‡æ† Y è½´ | ch1      | 364 - 1684             |
| å·¦æ‘‡æ† X è½´ | ch2      | 364 - 1684             |
| å·¦æ‘‡æ† Y è½´ | ch3      | 364 - 1684             |
| æ»šè½®        | scroll   | 364 - 1684             |
| å·¦å¼€å…³ S1   | s1       | 1(ä¸Š) / 3(ä¸­) / 2(ä¸‹)  |
| å³å¼€å…³ S2   | s2       | 1(ä¸Š) / 3(ä¸­) / 2(ä¸‹)  |

---

## ğŸ”§ æ ¸å¿ƒç±»

```cpp
namespace BSP::REMOTE_CONTROL

class RemoteController
{
public:
    // æ„é€ å‡½æ•°
    RemoteController(int timeThreshold = 100);  // è¶…æ—¶æ—¶é—´ ms

    // è§£ææ•°æ®ï¼ˆåœ¨ UART å›è°ƒä¸­è°ƒç”¨ï¼‰
    void parseData(const uint8_t* data);

    // ========== æ‘‡æ†æ•°æ®ï¼ˆå½’ä¸€åŒ– -1.0 åˆ° 1.0ï¼‰==========
    float get_left_x();    // å·¦æ‘‡æ† X
    float get_left_y();    // å·¦æ‘‡æ† Y
    float get_right_x();   // å³æ‘‡æ† X
    float get_right_y();   // å³æ‘‡æ† Y
    float get_scroll_();   // æ»šè½®

    // ========== é€šé“åŸå§‹æ•°æ®ï¼ˆå·²å‡å»ä¸­å€¼ï¼‰==========
    int16_t get_ch0(int16_t dead_zone = 0);
    int16_t get_ch1(int16_t dead_zone = 0);
    int16_t get_ch2(int16_t dead_zone = 0);
    int16_t get_ch3(int16_t dead_zone = 0);
    int16_t get_scroll(int16_t dead_zone = 0);

    // ========== å¼€å…³æ•°æ® ==========
    uint8_t get_s1();  // å·¦å¼€å…³ (1:ä¸Š, 3:ä¸­, 2:ä¸‹)
    uint8_t get_s2();  // å³å¼€å…³

    // ========== é”®ç›˜æ•°æ® ==========
    bool get_key(Keyboard key);  // æŸä¸ªé”®æ˜¯å¦æŒ‰ä¸‹

    // ========== é¼ æ ‡æ•°æ® ==========
    bool get_mouseLeft();   // é¼ æ ‡å·¦é”®
    bool get_mouseRight();  // é¼ æ ‡å³é”®

    // ========== çŠ¶æ€æ£€æµ‹ ==========
    void updateTimestamp();  // æ›´æ–°æ—¶é—´æˆ³
    bool isConnected();      // æ£€æŸ¥æ˜¯å¦åœ¨çº¿
};
```

---

## ğŸ“– è¯¦ç»†ä½¿ç”¨æ•™ç¨‹

### æ­¥éª¤ä¸€ï¼šåˆ›å»ºé¥æ§å™¨å¯¹è±¡

```cpp
#include "BSP/RemoteControl/DT7.hpp"

// åˆ›å»ºé¥æ§å™¨å¯¹è±¡ï¼ˆå…¨å±€å˜é‡ï¼‰
// å‚æ•°æ˜¯è¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤ 100ms æ²¡æ”¶åˆ°æ•°æ®å°±åˆ¤å®šæ‰çº¿
BSP::REMOTE_CONTROL::RemoteController remote(100);
```

### æ­¥éª¤äºŒï¼šåœ¨ UART å›è°ƒä¸­è§£ææ•°æ®

DT7 é¥æ§å™¨æ•°æ®é€šè¿‡ UART ä¼ è¾“ï¼Œä½ éœ€è¦åœ¨ UART æ¥æ”¶å›è°ƒä¸­è°ƒç”¨ `parseData()`ï¼š

```cpp
// æ¥æ”¶ç¼“å†²åŒº
uint8_t rx_buffer[18];  // DT7 åè®®å›ºå®š 18 å­—èŠ‚

// UART æ¥æ”¶å®Œæˆå›è°ƒï¼ˆä¸­æ–­æˆ– DMA å®Œæˆæ—¶è°ƒç”¨ï¼‰
void HAL_UART_RxCpltCallback(UART_HandleTypeDef *huart)
{
    if (huart == &huart1)  // å‡è®¾ç”¨ UART1
    {
        // è§£æé¥æ§å™¨æ•°æ®
        remote.parseData(rx_buffer);

        // æ›´æ–°æ—¶é—´æˆ³ï¼ˆç”¨äºæ‰çº¿æ£€æµ‹ï¼‰
        remote.updateTimestamp();

        // é‡æ–°å¼€å§‹æ¥æ”¶
        HAL_UART_Receive_DMA(&huart1, rx_buffer, 18);
    }
}
```

### æ­¥éª¤ä¸‰ï¼šè·å–æ‘‡æ†æ•°æ®

```cpp
void ControlTask()
{
    // ========== æ–¹å¼ä¸€ï¼šå½’ä¸€åŒ–å€¼ï¼ˆæ¨èï¼‰==========
    // èŒƒå›´ -1.0 åˆ° 1.0ï¼Œä¸­é—´ä¸º 0

    float left_x = remote.get_left_x();   // å·¦æ‘‡æ† Xï¼šå·¦-1 ~ å³+1
    float left_y = remote.get_left_y();   // å·¦æ‘‡æ† Yï¼šä¸‹-1 ~ ä¸Š+1
    float right_x = remote.get_right_x(); // å³æ‘‡æ† X
    float right_y = remote.get_right_y(); // å³æ‘‡æ† Y

    // ç›´æ¥ç”¨äºæ§åˆ¶
    float vx = left_y * 2.0f;  // å‰è¿›é€Ÿåº¦ Â±2 m/s
    float vy = left_x * 2.0f;  // å¹³ç§»é€Ÿåº¦
    float omega = right_x * 3.0f;  // æ—‹è½¬é€Ÿåº¦

    // ========== æ–¹å¼äºŒï¼šåŸå§‹å€¼ï¼ˆå¸¦æ­»åŒºï¼‰==========
    // èŒƒå›´ -660 åˆ° +660ï¼Œç”¨äºéœ€è¦æ›´å¤§åˆ†è¾¨ç‡çš„åœºæ™¯

    int16_t ch0 = remote.get_ch0(50);  // 50 æ˜¯æ­»åŒºï¼Œå°äº 50 çš„å€¼ä¼šå˜æˆ 0
    int16_t ch1 = remote.get_ch1(50);
}
```

### æ­¥éª¤å››ï¼šè·å–å¼€å…³çŠ¶æ€

å¼€å…³ç”¨äºåˆ‡æ¢æ¨¡å¼ï¼Œæœ‰ 3 ä¸ªæ¡£ä½ï¼š

```cpp
void ModeSelect()
{
    uint8_t s1 = remote.get_s1();  // å·¦å¼€å…³
    uint8_t s2 = remote.get_s2();  // å³å¼€å…³

    // ä½¿ç”¨æšä¸¾å¸¸é‡ï¼ˆæ›´æ¸…æ™°ï¼‰
    if (s1 == BSP::REMOTE_CONTROL::RemoteController::UP)
    {
        // S1 ä¸Šæ¡£ï¼šæ­£å¸¸æ¨¡å¼
    }
    else if (s1 == BSP::REMOTE_CONTROL::RemoteController::MIDDLE)
    {
        // S1 ä¸­æ¡£ï¼š...
    }
    else if (s1 == BSP::REMOTE_CONTROL::RemoteController::DOWN)
    {
        // S1 ä¸‹æ¡£ï¼šå¤±èƒ½
    }

    // æˆ–è€…ç”¨æ•°å­—
    switch (s2)
    {
        case 1:  // ä¸Š
            break;
        case 3:  // ä¸­
            break;
        case 2:  // ä¸‹
            break;
    }
}
```

### æ­¥éª¤äº”ï¼šè·å–é”®ç›˜çŠ¶æ€

é€šè¿‡å›¾ä¼ æ—¶å¯ä»¥ç”¨é”®ç›˜æ§åˆ¶ï¼š

```cpp
void KeyboardControl()
{
    // æ£€æŸ¥ W é”®æ˜¯å¦æŒ‰ä¸‹
    if (remote.get_key(BSP::REMOTE_CONTROL::RemoteController::KEY_W))
    {
        // å‰è¿›
    }

    // æ£€æŸ¥å¤šä¸ªé”®
    if (remote.get_key(BSP::REMOTE_CONTROL::RemoteController::KEY_A))
    {
        // å·¦ç§»
    }
    if (remote.get_key(BSP::REMOTE_CONTROL::RemoteController::KEY_SHIFT))
    {
        // åŠ é€Ÿ
    }
}
```

å¯ç”¨çš„æŒ‰é”®ï¼š

```cpp
KEY_W, KEY_S, KEY_A, KEY_D,  // WASD
KEY_Q, KEY_E, KEY_R, KEY_F, KEY_G,
KEY_Z, KEY_X, KEY_C, KEY_V, KEY_B,
KEY_SHIFT, KEY_CTRL
```

### æ­¥éª¤å…­ï¼šæ‰çº¿æ£€æµ‹

```cpp
void SafetyCheck()
{
    if (!remote.isConnected())
    {
        // é¥æ§å™¨æ‰çº¿ï¼
        // èœ‚é¸£å™¨ä¼šè‡ªåŠ¨æŠ¥è­¦

        // åº”è¯¥åœæ­¢æ‰€æœ‰ç”µæœºï¼
        StopAllMotors();
    }
}
```

---

## ğŸ“Š å®Œæ•´ç¤ºä¾‹ï¼šåº•ç›˜æ§åˆ¶

```cpp
#include "BSP/RemoteControl/DT7.hpp"

BSP::REMOTE_CONTROL::RemoteController remote;

void ChassisControlByRemote()
{
    // å®‰å…¨æ£€æŸ¥
    if (!remote.isConnected())
    {
        // æ‰çº¿æ—¶åœæ­¢
        StopChassis();
        return;
    }

    // è·å–å¼€å…³çŠ¶æ€åˆ¤æ–­æ¨¡å¼
    uint8_t s1 = remote.get_s1();

    if (s1 == 2)  // S1 ä¸‹æ¡£ï¼šå¤±èƒ½
    {
        StopChassis();
        return;
    }

    // è·å–æ‘‡æ†æ•°æ®
    float left_x = remote.get_left_x();
    float left_y = remote.get_left_y();
    float right_x = remote.get_right_x();

    // æ˜ å°„åˆ°é€Ÿåº¦
    float vx = left_y * MAX_VX;
    float vy = left_x * MAX_VY;
    float omega = right_x * MAX_OMEGA;

    // å‘ç»™åº•ç›˜æ§åˆ¶
    ChassisSetSpeed(vx, vy, omega);
}
```

---

## âš ï¸ å¸¸è§é—®é¢˜

### Q1: æ‘‡æ†ä¸åŠ¨ä¹Ÿæœ‰å€¼ï¼Ÿ

æ‘‡æ†æœ‰æœºæ¢°è¯¯å·®ï¼Œä¸­é—´ä½ç½®å¯èƒ½ä¸æ˜¯ç²¾ç¡®çš„ 0ã€‚ä½¿ç”¨**æ­»åŒº**ï¼š

```cpp
// æ­»åŒº 50ï¼Œå°äº 50 çš„å€¼ä¼šå˜æˆ 0
int16_t ch = remote.get_ch0(50);

// æˆ–è€…ç”¨å½’ä¸€åŒ–å€¼æ—¶è‡ªå·±å¤„ç†
float x = remote.get_left_x();
if (fabs(x) < 0.1f) x = 0;  // 10% ä»¥å†…ç®—ä½œ 0
```

### Q2: é¥æ§å™¨ä¸€ç›´æ˜¾ç¤ºæ‰çº¿ï¼Ÿ

æ£€æŸ¥ï¼š

1. âœ… UART é…ç½®æ­£ç¡®ï¼ˆæ³¢ç‰¹ç‡ 100000ï¼‰
2. âœ… æ•°æ®çº¿è¿æ¥æ­£ç¡®
3. âœ… åœ¨å›è°ƒä¸­è°ƒç”¨äº† `updateTimestamp()`
4. âœ… DMA æ¥æ”¶é…ç½®æ­£ç¡®

### Q3: å¼€å…³çŠ¶æ€è¯»ä¸å¯¹ï¼Ÿ

æ³¨æ„ï¼šå¼€å…³å€¼ä¸æ˜¯ 1-2-3 é¡ºåºï¼Œè€Œæ˜¯ 1(ä¸Š)-3(ä¸­)-2(ä¸‹)ï¼

### Q4: é”®ç›˜æ²¡ååº”ï¼Ÿ

é”®ç›˜æ•°æ®åªæœ‰åœ¨è¿æ¥å›¾ä¼ æ—¶æ‰æœ‰ï¼Œç›´æ¥ç”¨é¥æ§å™¨çš„è¯é”®ç›˜æ•°æ®éƒ½æ˜¯ 0ã€‚
