# PID - PID æ§åˆ¶å™¨

> ğŸ“š **å‰ç½®çŸ¥è¯†**ï¼šç†è§£ä»€ä¹ˆæ˜¯åé¦ˆæ§åˆ¶
>
> PID æ˜¯æœºå™¨äººæ§åˆ¶ä¸­æœ€åŸºç¡€ã€æœ€å¸¸ç”¨çš„ç®—æ³•ï¼å¿…é¡»æŒæ¡ï¼

---

## ğŸ¯ ä»€ä¹ˆæ˜¯ PIDï¼Ÿ

### ç”Ÿæ´»ä¸­çš„ä¾‹å­

æƒ³è±¡ä½ åœ¨æ·‹æµ´ï¼š

- **ç›®æ ‡**ï¼šæ°´æ¸© 40Â°C
- **åé¦ˆ**ï¼šä½ çš„çš®è‚¤æ„Ÿå—åˆ°å½“å‰æ°´æ¸©
- **æ§åˆ¶**ï¼šè½¬åŠ¨æ°´é¾™å¤´

ä½ æ˜¯æ€ä¹ˆè°ƒèŠ‚çš„ï¼Ÿ

1. **Pï¼ˆæ¯”ä¾‹ï¼‰**ï¼šæ°´å¤ªå†·ï¼Œå°±å¤šå¼€çƒ­æ°´ï¼›æ°´å¤ªçƒ­ï¼Œå°±å…³çƒ­æ°´ã€‚å·®è·è¶Šå¤§ï¼Œè°ƒèŠ‚è¶ŠçŒ›
2. **Iï¼ˆç§¯åˆ†ï¼‰**ï¼šæ°´ä¸€ç›´åå†·ä¸€ç‚¹ç‚¹ï¼Œè¯´æ˜ä¹‹å‰çš„è°ƒèŠ‚ä¸å¤Ÿï¼Œéœ€è¦ç´¯ç§¯è¯¯å·®ç»§ç»­è°ƒ
3. **Dï¼ˆå¾®åˆ†ï¼‰**ï¼šæ°´æ¸©åœ¨å¿«é€Ÿä¸Šå‡ï¼Œæå‰å‡å°çƒ­æ°´ï¼Œé˜²æ­¢è¶…è°ƒ

è¿™å°±æ˜¯ PID çš„æ ¸å¿ƒæ€æƒ³ï¼

### å…¬å¼

```
è¾“å‡º = Kp Ã— è¯¯å·® + Ki Ã— è¯¯å·®ç§¯åˆ† + Kd Ã— è¯¯å·®å˜åŒ–ç‡

å…¶ä¸­ï¼š
- è¯¯å·® = ç›®æ ‡å€¼ - å½“å‰å€¼
- Kp, Ki, Kd æ˜¯éœ€è¦è°ƒèŠ‚çš„å‚æ•°
```

---

## ğŸ“¦ è¿™ä¸ªæ¨¡å—æä¾›ä»€ä¹ˆï¼Ÿ

ä¸€ä¸ªåŠŸèƒ½å®Œæ•´çš„ PID æ§åˆ¶å™¨ç±»ï¼ŒåŒ…å«ï¼š

- **åŸºæœ¬ PID è®¡ç®—**
- **è¾“å‡ºé™å¹…**ï¼šé˜²æ­¢è¾“å‡ºè¿‡å¤§æŸåç”µæœº
- **ç§¯åˆ†é™å¹…**ï¼šé˜²æ­¢ç§¯åˆ†é¥±å’Œï¼ˆç§¯åˆ†å€¼å¤ªå¤§ï¼‰
- **ç§¯åˆ†åˆ†ç¦»**ï¼šè¯¯å·®å¤§æ—¶ä¸ç§¯åˆ†ï¼Œé˜²æ­¢è¶…è°ƒ

---

## ğŸ”§ API è¯¦è§£

### åˆ›å»º PID æ§åˆ¶å™¨

```cpp
#include "Alg/PID/pid.hpp"

// æ„é€ å‡½æ•°å‚æ•°è¯´æ˜ï¼š
// PID(Kp, Ki, Kd, è¾“å‡ºé™å¹…, ç§¯åˆ†é™å¹…, ç§¯åˆ†åˆ†ç¦»é˜ˆå€¼)

ALG::PID::PID my_pid(
    10.0f,    // Kp: æ¯”ä¾‹ç³»æ•°
    0.1f,     // Ki: ç§¯åˆ†ç³»æ•°
    0.5f,     // Kd: å¾®åˆ†ç³»æ•°
    10000.0f, // è¾“å‡ºé™å¹…: è¾“å‡ºä¸è¶…è¿‡ Â±10000
    5000.0f,  // ç§¯åˆ†é™å¹…: ç§¯åˆ†é¡¹ä¸è¶…è¿‡ Â±5000
    500.0f    // ç§¯åˆ†åˆ†ç¦»: è¯¯å·® > 500 æ—¶ä¸ç§¯åˆ†
);
```

### è¿›è¡Œ PID è®¡ç®—

```cpp
// æ¯ä¸ªæ§åˆ¶å‘¨æœŸè°ƒç”¨ä¸€æ¬¡ï¼ˆæ¯”å¦‚æ¯ 1msï¼‰
float output = my_pid.UpDate(ç›®æ ‡å€¼, å½“å‰å€¼);
```

å°±è¿™ä¹ˆç®€å•ï¼`output` å°±æ˜¯ä½ è¦å‘ç»™ç”µæœºçš„æ§åˆ¶é‡ã€‚

### å…¶ä»–å¸¸ç”¨å‡½æ•°

```cpp
// é‡ç½®PIDï¼ˆåˆ‡æ¢ç›®æ ‡æ—¶å»ºè®®é‡ç½®ï¼‰
my_pid.reset();

// å•ç‹¬è®¾ç½®ç›®æ ‡å’Œåé¦ˆï¼ˆä¸å¸¸ç”¨ï¼‰
my_pid.setTarget(1000.0f);
my_pid.setFeedback(800.0f);

// ä¿®æ”¹PIDå‚æ•°
my_pid.setK(12.0f, 0.15f, 0.6f);

// ä¿®æ”¹è¾“å‡ºé™å¹…
my_pid.setMax(8000.0f);

// è·å–å½“å‰è¾“å‡º
float current_output = my_pid.getOutput();

// è·å–å½“å‰è¯¯å·®
float current_error = my_pid.getError();
```

---

## ğŸ“– è¯¦ç»†ä½¿ç”¨æ•™ç¨‹

### åœºæ™¯ä¸€ï¼šç”µæœºé€Ÿåº¦æ§åˆ¶

æœ€å¸¸è§çš„åº”ç”¨ï¼ç›®æ ‡æ˜¯è®©ç”µæœºä¿æŒæŸä¸ªè½¬é€Ÿã€‚

```cpp
#include "Alg/PID/pid.hpp"
#include "BSP/Motor/Dji/DjiMotor.hpp"

// åˆ›å»º PID æ§åˆ¶å™¨
// é€Ÿåº¦ç¯ä¸€èˆ¬ Kp è¾ƒå¤§ï¼ŒKi è¾ƒå°ï¼ŒKd å¯ä»¥ä¸º 0
ALG::PID::PID speed_pid(15.0f, 0.5f, 0.0f, 10000.0f, 5000.0f, 1000.0f);

// ç›®æ ‡é€Ÿåº¦ï¼ˆrpmï¼‰
float target_speed = 2000.0f;

// æ§åˆ¶ä»»åŠ¡ï¼ˆ1ms å‘¨æœŸï¼‰
void SpeedControlTask()
{
    // 1. è·å–å½“å‰é€Ÿåº¦
    float current_speed = chassis_motor.getVelocityRpm(1);

    // 2. PID è®¡ç®—
    float output = speed_pid.UpDate(target_speed, current_speed);

    // 3. å‘é€åˆ°ç”µæœº
    int16_t current[4] = {(int16_t)output, 0, 0, 0};
    chassis_motor.SendCommand(current);
}
```

### åœºæ™¯äºŒï¼šç”µæœºä½ç½®æ§åˆ¶ï¼ˆä¸²çº§ PIDï¼‰

ä½ç½®æ§åˆ¶éœ€è¦ç”¨**ä¸¤ä¸ª PID**ä¸²è”ï¼š

- **å¤–ç¯ï¼ˆä½ç½®ç¯ï¼‰**ï¼šè¾“å…¥ç›®æ ‡è§’åº¦ï¼Œè¾“å‡ºç›®æ ‡é€Ÿåº¦
- **å†…ç¯ï¼ˆé€Ÿåº¦ç¯ï¼‰**ï¼šè¾“å…¥ç›®æ ‡é€Ÿåº¦ï¼Œè¾“å‡ºç”µæµ

```
ç›®æ ‡è§’åº¦ â†’ [ä½ç½®PID] â†’ ç›®æ ‡é€Ÿåº¦ â†’ [é€Ÿåº¦PID] â†’ ç”µæµ â†’ ç”µæœº
                â†‘                      â†‘
            å½“å‰è§’åº¦                å½“å‰é€Ÿåº¦
```

```cpp
// ä½ç½®ç¯ PIDï¼ˆå¤–ç¯ï¼Œè¾ƒæ…¢ï¼‰
ALG::PID::PID pos_pid(5.0f, 0.01f, 0.5f, 5000.0f, 1000.0f, 100.0f);

// é€Ÿåº¦ç¯ PIDï¼ˆå†…ç¯ï¼Œè¾ƒå¿«ï¼‰
ALG::PID::PID speed_pid(15.0f, 0.5f, 0.0f, 10000.0f, 5000.0f, 1000.0f);

float target_angle = 90.0f;  // ç›®æ ‡è§’åº¦ï¼ˆåº¦ï¼‰

void PositionControlTask()
{
    // 1. è·å–å½“å‰è§’åº¦å’Œé€Ÿåº¦
    float current_angle = motor.getAngleDeg(1);
    float current_speed = motor.getVelocityRpm(1);

    // 2. ä½ç½®ç¯è®¡ç®— â†’ å¾—åˆ°ç›®æ ‡é€Ÿåº¦
    float target_speed = pos_pid.UpDate(target_angle, current_angle);

    // 3. é€Ÿåº¦ç¯è®¡ç®— â†’ å¾—åˆ°ç”µæµ
    float output = speed_pid.UpDate(target_speed, current_speed);

    // 4. å‘é€ç”µæµ
    int16_t current[1] = {(int16_t)output};
    motor.SendCommand(current);
}
```

### åœºæ™¯ä¸‰ï¼šå¤šç”µæœºç‹¬ç«‹æ§åˆ¶

æ¯ä¸ªç”µæœºéœ€è¦**ç‹¬ç«‹çš„ PID æ§åˆ¶å™¨**ï¼

```cpp
// 4 ä¸ªç”µæœºï¼Œ4 ä¸ª PID
ALG::PID::PID motor_pid[4] = {
    {10.0f, 0.1f, 0.5f, 10000.0f, 5000.0f, 500.0f},
    {10.0f, 0.1f, 0.5f, 10000.0f, 5000.0f, 500.0f},
    {10.0f, 0.1f, 0.5f, 10000.0f, 5000.0f, 500.0f},
    {10.0f, 0.1f, 0.5f, 10000.0f, 5000.0f, 500.0f}
};

float target[4] = {1000, 1000, 1000, 1000};  // å„ç”µæœºç›®æ ‡è½¬é€Ÿ

void MultiMotorControl()
{
    int16_t current[4];

    for (int i = 0; i < 4; i++)
    {
        float cur_speed = chassis_motor.getVelocityRpm(i + 1);
        float output = motor_pid[i].UpDate(target[i], cur_speed);
        current[i] = (int16_t)output;
    }

    chassis_motor.SendCommand(current);
}
```

---

## ğŸ›ï¸ PID å‚æ•°è°ƒèŠ‚æŒ‡å—

### è°ƒå‚æ­¥éª¤ï¼ˆé»„é‡‘æ³•åˆ™ï¼‰

1. **å…ˆæŠŠ Ki å’Œ Kd è®¾ä¸º 0**

   ```cpp
   my_pid.setK(10.0f, 0.0f, 0.0f);  // åªæœ‰ P
   ```

2. **é€æ¸å¢å¤§ Kp**
   - ä»å°å€¼å¼€å§‹ï¼ˆæ¯”å¦‚ 1.0ï¼‰
   - è§‚å¯Ÿå“åº”ï¼Œé€æ¸å¢å¤§
   - ç›´åˆ°ç³»ç»Ÿå¼€å§‹**æŒ¯è¡**ï¼ˆæ¥å›æŠ–åŠ¨ï¼‰

3. **å‡å° Kp åˆ°çº¦ 60%**
   
- å¦‚æœæŒ¯è¡æ—¶ Kp = 20ï¼Œå°±è®¾ä¸º 12 å·¦å³
   
4. **åŠ å…¥ Ki æ¶ˆé™¤ç¨³æ€è¯¯å·®**
   - å¦‚æœç³»ç»Ÿç¨³å®šåè¿˜æœ‰ä¸€ç‚¹åå·®ï¼Œå°±åŠ  Ki
   - ä»å¾ˆå°çš„å€¼å¼€å§‹ï¼ˆæ¯”å¦‚ 0.01ï¼‰
   - ä¸è¦åŠ å¤ªå¤§ï¼Œå¦åˆ™ä¼šè¶…è°ƒ

5. **å¦‚æœéœ€è¦ï¼ŒåŠ å…¥ Kd**
   - Kd å¯ä»¥æŠ‘åˆ¶è¶…è°ƒï¼Œè®©å“åº”æ›´å¿«æ”¶æ•›
   - ä½†å¤ªå¤§ä¼šæ”¾å¤§å™ªå£°

### å¸¸è§é—®é¢˜åŠè§£å†³

| ç°è±¡             | å¯èƒ½åŸå›           | è§£å†³æ–¹æ³•         |
| ---------------- | ----------------- | ---------------- |
| ä¸åŠ¨             | Kp å¤ªå°           | å¢å¤§ Kp          |
| æŒ¯è¡             | Kp å¤ªå¤§           | å‡å° Kp          |
| ç¨³æ€æœ‰è¯¯å·®       | Ki å¤ªå°æˆ–æ²¡æœ‰     | å¢å¤§ Ki          |
| è¶…è°ƒä¸¥é‡         | Ki å¤ªå¤§æˆ– Kd å¤ªå° | å‡å° Kiï¼Œå¢å¤§ Kd |
| å“åº”å¤ªæ…¢         | Kp å¤ªå°           | å¢å¤§ Kp          |
| æŠ–åŠ¨ï¼ˆé«˜é¢‘æŒ¯è¡ï¼‰ | Kd å¤ªå¤§           | å‡å° Kd          |

### ä¸åŒåœºæ™¯çš„å‚æ•°ç‰¹ç‚¹

| åœºæ™¯   | Kp  | Ki   | Kd    | è¯´æ˜     |
| ------ | --- | ---- | ----- | -------- |
| é€Ÿåº¦ç¯ | å¤§  | å°   | å°æˆ–0 | å¿«é€Ÿå“åº” |
| ä½ç½®ç¯ | ä¸­  | å¾ˆå° | ä¸­    | ç²¾ç¡®æ§åˆ¶ |
| è§’åº¦ç¯ | ä¸­  | å°   | è¾ƒå¤§  | é˜²æ­¢è¶…è°ƒ |

---

## âš™ï¸ é«˜çº§åŠŸèƒ½è§£é‡Š

### è¾“å‡ºé™å¹…

é˜²æ­¢ PID è¾“å‡ºè¿‡å¤§æŸåç”µæœºæˆ–è¶…å‡ºæ§åˆ¶èŒƒå›´ã€‚

```cpp
// è®¾ç½®è¾“å‡ºé™å¹…ä¸º Â±8000
my_pid.setMax(8000.0f);

// å³ä½¿ PID è®¡ç®—å‡º 12000ï¼Œä¹Ÿä¼šè¢«é™åˆ¶åˆ° 8000
```

### ç§¯åˆ†é™å¹…

é˜²æ­¢**ç§¯åˆ†é¥±å’Œ**ï¼ˆIntegral Windupï¼‰ã€‚

ä»€ä¹ˆæ˜¯ç§¯åˆ†é¥±å’Œï¼Ÿå½“ç›®æ ‡çªç„¶å˜åŒ–å¾ˆå¤§æ—¶ï¼Œè¯¯å·®ä¼šæŒç»­ç´¯ç§¯ï¼Œå¯¼è‡´ç§¯åˆ†é¡¹å˜å¾—å¾ˆå¤§ï¼Œç„¶åè¿‡å†²å¾ˆä¹…æ‰èƒ½æ¢å¤ã€‚

```cpp
// ç§¯åˆ†é¡¹çš„ç»å¯¹å€¼ä¸ä¼šè¶…è¿‡ 5000
PID my_pid(10, 0.1f, 0, 10000, 5000, 500);
//                            â†‘
//                        ç§¯åˆ†é™å¹…
```

### ç§¯åˆ†åˆ†ç¦»

è¯¯å·®å¾ˆå¤§æ—¶ä¸è¿›è¡Œç§¯åˆ†ï¼Œåªæœ‰è¯¯å·®è¾ƒå°æ—¶æ‰ç§¯åˆ†ã€‚

```cpp
// è¯¯å·® > 500 æ—¶ä¸ç§¯åˆ†
PID my_pid(10, 0.1f, 0, 10000, 5000, 500);
//                                   â†‘
//                              ç§¯åˆ†åˆ†ç¦»é˜ˆå€¼
```

---

## ğŸ” è°ƒè¯•æŠ€å·§

### ä½¿ç”¨ LOGGER æ‰“å°

```cpp
#include "HAL/LOGGER/logger.hpp"

void DebugPID()
{
    float target = 1000.0f;
    float current = motor.getVelocityRpm(1);
    float output = my_pid.UpDate(target, current);

    // æ‰“å°è°ƒè¯•ä¿¡æ¯
    LOG_INFO("T:%.1f C:%.1f E:%.1f O:%.1f",
             target, current, my_pid.getError(), output);
}
```

### ä½¿ç”¨ä¸Šä½æœº

å¯ä»¥æŠŠæ•°æ®å‘åˆ°ä¸Šä½æœºç»˜åˆ¶æ›²çº¿ï¼Œç›´è§‚çœ‹åˆ°å“åº”è¿‡ç¨‹ã€‚

---

## âš ï¸ å¸¸è§é”™è¯¯

### é”™è¯¯ 1ï¼šå¿˜è®°è°ƒç”¨ UpDate()

```cpp
// é”™è¯¯ï¼šåªè®¾ç½®äº†ç›®æ ‡ï¼Œæ²¡æœ‰è®¡ç®—
my_pid.setTarget(1000);
// è¿™æ · getOutput() è¿˜æ˜¯æ—§å€¼ï¼

// æ­£ç¡®ï¼šè°ƒç”¨ UpDate()
float output = my_pid.UpDate(1000, current_speed);
```

### é”™è¯¯ 2ï¼šåªç”¨ä¸€ä¸ª PID æ§åˆ¶å¤šä¸ªç”µæœº

```cpp
// é”™è¯¯ï¼š4 ä¸ªç”µæœºå…±ç”¨ä¸€ä¸ª PID
PID shared_pid(10, 0.1f, 0.5f, 10000, 5000, 500);
for (int i = 0; i < 4; i++) {
    shared_pid.UpDate(target[i], speed[i]);  // ç§¯åˆ†é¡¹ä¼šä¹±ï¼
}

// æ­£ç¡®ï¼šæ¯ä¸ªç”µæœºç‹¬ç«‹çš„ PID
PID motor_pid[4] = {...};
```

### é”™è¯¯ 3ï¼šæ§åˆ¶å‘¨æœŸä¸å›ºå®š

PID å¯¹æ§åˆ¶å‘¨æœŸæ•æ„Ÿï¼Œå¦‚æœå‘¨æœŸä¸å›ºå®šï¼Œæ•ˆæœä¼šå¾ˆå·®ã€‚

```cpp
// ç¡®ä¿æ§åˆ¶ä»»åŠ¡ä»¥å›ºå®šå‘¨æœŸè¿è¡Œ
// é€šå¸¸ç”¨å®šæ—¶å™¨ä¸­æ–­ï¼Œ1ms å‘¨æœŸ
```

## è°ƒç”¨ç¤ºä¾‹

### åˆå§‹åŒ–

```cpp
// ç¬¬ä¸€ä¸ªæ•°æ®kp ç¬¬äºŒä¸ªki ç¬¬ä¸‰ä¸ªkd ç¬¬å››ä¸ªæœ€å¤§è¾“å‡º ç¬¬äº”ä¸ªç§¯åˆ†é™å¹… ç¬¬å…­ä¸ªç§¯åˆ†éš”ç¦»é˜ˆå€¼
// åˆ›å»ºæ•°ç»„çš„
ALG::PID::PID translational_pid[2] = {
    ALG::PID::PID(300.0f, 0.0f, 0.0f, 16384.0f, 2500.0f, 100.0f),
    ALG::PID::PID(300.0f, 0.0f, 0.0f, 16384.0f, 2500.0f, 100.0f)
};
// åˆ›å»ºå•ä¸ª
ALG::PID::PID rotational_pid(200.0f, 0.0f, 0.0f, 16384.0f, 2500.0f, 100.0f);
```

### è°ƒç”¨

```cpp
// é‡ç½® éƒ½ç½®ä¸º0
translational_pid[0].reset();
translational_pid[1].reset();
rotational_pid.reset();

// è®¡ç®— æœŸæœ›å’Œåé¦ˆ
translational_pid[0].UpDate(chassis_target.target_translation_x, string_fk.GetChassisVx()); 
```

