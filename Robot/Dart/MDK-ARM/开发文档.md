# 飞镖控制系统文档

## 项目运行流程

本项目是一个基于嵌入式系统的飞镖发射控制系统，主要使用C++编写。程序的核心是负责处理飞镖的各种控制逻辑。

### 主要组件

- **系统初始化**：在[DartInit()](javascript:void(0))中完成飞镖相关参数、CAN过滤器以及UART通信的初始化。
- **主循环**：在`Gimbal(void *argument)`函数中执行无限循环，定期调用[RegularEvent()](javascript:void(0))来检查并更新系统状态。

```c++
void Gimbal(void *argument)
{
    TickType_t Lasttick = xTaskGetTickCount();
    Dart.DartInit(); // 初始化飞镖相关参数和通信
    for (;;) {
        Dart.RegularEvent(); // 定期事件函数
        SystemTick = xTaskGetTickCount(); // 获取当前系统滴答计数
        vTaskDelayUntil(&Lasttick, pdMS_TO_TICKS(1));
    }
}
```

## 遥控器操作方式

用户可以通过遥控器上的开关和摇杆对系统进行实时控制。以下是具体的操作映射：

### 模式切换 (`SwitchModeCheck`)

- `s1 == UP`: 进入摩擦轮速度控制模式（FriSpeedControl）
- `s1 == MID`: 进入手动电机控制模式（ManualMotorControl）
- `s1 == DOWN`: 启动自动发射模式（AutoLaunchMode）

### 速度控制 (`SpeedControl`)

- `s2 == UP`: 增加摩擦轮目标转速 +500
- `s2 == MID && ch1 >= 500`: 增加摩擦轮目标转速 +100
- `s2 == MID && ch3 >= 500`: 增加摩擦轮目标转速 +10
- `s2 == DOWN`: 减少摩擦轮目标转速 -500
- `s2 == MID && ch1 <= -500`: 减少摩擦轮目标转速 -100
- `s2 == MID && ch3 <= -500`: 减少摩擦轮目标转速 -10

### 手动电机控制 (`ManualMotorControl`)

- `s2 == UP`: 设置垂直升降电机目标转速为 6000
- `s2 == MID`: 停止垂直升降电机并解除锁定状态
- `s2 == DOWN`: 设置垂直升降电机目标转速为 -6000

### 自动发射模式 (`AutoLaunchMode`)

- `s2 == UP`: 自动发射第一次15s飞镖，中置可发射第二次
- `s2 == MID`: 裁判系统模式，满足条件会自动发射，大致同上
- `s2 == DOWN`: 双下急停模式

## 关键函数及简介

以下是一些关键函数及其简要说明：

| 函数名                                                       | 描述                               |
| :----------------------------------------------------------- | :--------------------------------- |
| `DartInit()`                                                 | 初始化飞镖参数和通信接口           |
| `RegularEvent()`                                             | 定期执行各种系统检查与更新         |
| `RfSysCheck()`                                               | 检查裁判系统状态                   |
| `LimitCheck()`                                               | 读取左右极限开关的状态             |
| `ControlerCheck()`                                           | 检查遥控器连接状态                 |
| `SwitchModeCheck()`                                          | 根据遥控器输入切换控制模式         |
| `FriSpeedControl()`                                          | 调整摩擦轮电机的目标转速           |
| `ManualMotorControl()`                                       | 控制Yaw轴角度及丝杆运动            |
| `AutoLaunchMode()`                                           | 根据条件启动自动发射模式           |
| `EmergencyStop()`                                            | 紧急停止所有电机动作               |
| `StartAutoLaunch(int mode)`                                  | 启动自动发射流程                   |
| `EqualizeFriMotorSpeed()`                                    | 统一四个摩擦轮的速度               |
| `SyncYawAngle()`                                             | 同步Yaw轴目标角度到PID控制器       |
| `Set_Motor_Target(int *target_motor, int value, int min, int max)` | 设置电机目标值并确保其在有效范围内 |
| `Add_Motor_Target(int *target_motor, int add_value, int min, int max)` | 增加电机目标值并在范围内限制       |