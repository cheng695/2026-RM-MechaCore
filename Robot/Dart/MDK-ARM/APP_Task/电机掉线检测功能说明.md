# 电机掉线检测和蜂鸣器报警功能说明

## 功能概述

本功能实现了对8个电机的掉线检测和蜂鸣器报警功能。当某个电机超过100ms没有接收到数据时，系统会通过蜂鸣器发出报警声。

## 电机ID映射

| 电机ID | CAN ID | 电机名称 | 报警次数 |
|--------|--------|----------|----------|
| 1 | 0x201 | 右下摩擦轮 | 2次 |
| 2 | 0x202 | 右上摩擦轮 | 3次 |
| 3 | 0x203 | 左上摩擦轮 | 4次 |
| 4 | 0x204 | 左下摩擦轮 | 5次 |
| 5 | 0x205 | Yaw轴电机 | 6次 |
| 6 | 0x206 | 左右丝杆电机 | 7次 |
| 7 | 0x207 | 上下丝杆推进器电机 | 8次 |
| 8 | 0x208 | 编码器电机 | 9次 |

## 报警规则

1. **掉线检测**：电机超过100ms没有接收到CAN数据时，判定为掉线
2. **报警次数**：每个电机的报警次数为其ID+1（例如：3号电机响4次）
3. **报警时长**：每次报警持续100ms
4. **报警间隔**：每次报警之间间隔50ms
5. **多电机处理**：当有多个电机同时掉线时，按顺序依次报警
6. **电机间等待**：完成一个电机的报警后等待2000ms，然后开始下一个电机的报警
7. **循环等待**：完成所有电机的报警后等待2000ms，然后重新开始报警
8. **恢复检测**：当电机重新接收到数据时，立即停止报警并从队列中移除

## 时间参数

- **掉线阈值**：100ms
- **报警时长**：20ms
- **报警间隔**：10ms
- **电机间等待**：2000ms
- **循环等待**：2000ms
- **检测频率**：每10ms检测一次
- **蜂鸣器频率**：523Hz（中音1）

## 蜂鸣器控制

- **频率**：523Hz（中音1）
- **占空比**：20%
- **优先级**：电机掉线报警优先于音乐播放

## 文件结构

```
APP_Task/
├── MotorOfflineDetector.hpp    # 头文件
├── MotorOfflineDetector.cpp    # 实现文件
└── 电机掉线检测功能说明.md     # 说明文档
```

## 使用方法

1. **初始化**：系统启动时自动调用 `MotorOfflineDetector_Init()`
2. **状态更新**：在 `RmMotorGetCanData()` 中自动调用 `MotorOfflineDetector_UpdateMotorStatus()`
3. **定期检测**：在 `TimerCallback()` 中每10ms调用 `MotorOfflineDetector_Update()`

## 注意事项

1. 该功能使用TIM12的CH1通道控制蜂鸣器
2. 当有电机掉线报警时，音乐播放功能会被暂停
3. 多个电机同时掉线时，按电机ID顺序依次报警
4. 电机恢复连接后，报警会立即停止并从队列中移除
5. 报警队列采用先进先出（FIFO）原则
6. 系统会自动处理电机的加入和移除队列

## 多电机报警示例

假设3号和5号电机同时掉线：

1. **第一轮报警**：
   - 先响3号电机：响4次（每次20ms，间隔10ms）
   - 等待2000ms
   - 再响5号电机：响6次（每次20ms，间隔10ms）
   - 等待2000ms

2. **第二轮报警**：
   - 重复上述过程：3号响4次 → 等待2秒 → 5号响6次 → 等待2秒

3. **恢复检测**：
   - 如果3号电机恢复，立即停止3号报警，继续5号报警
   - 如果5号电机恢复，立即停止5号报警，继续3号报警
   - 如果两个电机都恢复，停止所有报警

**注意**：每个电机只会响一次自己的完整次数，然后立即切换到下一个电机，不会重复响两次。

## 调试信息

可以通过以下方式监控电机状态：

```cpp
// 检查电机是否掉线
if (motor_status[motor_id].is_offline) {
    // 电机已掉线
}

// 检查蜂鸣器状态
if (buzzer_control.state != BUZZER_IDLE) {
    // 蜂鸣器正在报警
}

// 检查队列中的电机数量
uint8_t queue_count = buzzer_control.queue_count;
``` 